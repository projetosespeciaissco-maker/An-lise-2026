<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Clipping JornalÃ­stico</title>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { background:#1f2937; color:#fff; padding:15px; text-align:center; font-size:18px; }
.hidden{display:none;}
#loginBox, #app { padding:20px; }

input, textarea, select {
  width:100%; box-sizing:border-box; padding:10px; margin-top:8px;
  border:1px solid #ccc; border-radius:6px; font-size:14px;
}
label{ font-size:12px; color:#444; margin-top:10px; display:block; }

button{
  width:100%; padding:10px; margin-top:10px;
  border-radius:6px; border:1px solid #ccc; cursor:pointer;
  background:#fff;
}
button:hover{ background:#eee; }

.rowBtns{ display:flex; gap:8px; }
.rowBtns button{ width:50%; }

.container{ display:flex; gap:20px; align-items:flex-start; }
.form{ width:32%; background:#fff; padding:15px; border-radius:8px; }
.columns{ width:68%; display:flex; gap:10px; }
.column{ flex:1; background:#fff; padding:10px; border-radius:8px; min-height:300px; }
.column h3{ text-align:center; margin:10px 0; }

.item{
  border-bottom:1px solid #ddd;
  padding:8px 0;
}
.item strong{ display:block; margin-bottom:4px; }
.item a{ font-size:12px; color:#2563eb; word-break:break-all; }
.item small{ display:block; color:#555; margin-top:3px; }

.actions{ margin-top:8px; display:flex; gap:8px; }
.actions button{
  width:auto; padding:5px 8px; font-size:12px;
  border-radius:6px;
}
.btnDel{ border-color:#fca5a5; }
.btnDel:hover{ background:#fee2e2; }
.btnEdit{ border-color:#93c5fd; }
.btnEdit:hover{ background:#dbeafe; }

.notice{
  background:#e7f7ee;
  border:1px solid #b7ebcd;
  color:#0f5132;
  padding:8px;
  border-radius:6px;
  margin-top:10px;
  font-size:13px;
}
.notice.warn{
  background:#fff3cd;
  border:1px solid #ffeeba;
  color:#6b4e00;
}
.badgeEdit{
  display:inline-block;
  margin-top:8px;
  font-size:12px;
  color:#374151;
  background:#f3f4f6;
  border:1px solid #e5e7eb;
  padding:6px 8px;
  border-radius:999px;
}
</style>
</head>

<body>
<header>ğŸ“Š Clipping JornalÃ­stico</header>

<!-- LOGIN -->
<div id="loginBox">
  <h3>ğŸ”’ Acesso</h3>
  <input type="password" id="senha" placeholder="Senha">
  <button onclick="entrar()">Entrar</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="container">

    <!-- FORMULÃRIO -->
    <div class="form">
      <h3>â• MatÃ©ria</h3>

      <input id="autor" placeholder="Seu nome (quem analisou)">

      <!-- NOVO -->
      <input id="tituloAnalise" placeholder="TÃ­tulo da anÃ¡lise">

      <input id="titulo" placeholder="TÃ­tulo da matÃ©ria">
      <input id="veiculo" placeholder="VeÃ­culo (ex: G1, EstadÃ£o)">
      <input id="autoriaMateria" placeholder="Autoria da matÃ©ria">

      <label>ğŸ“… Data da matÃ©ria</label>
      <input type="date" id="dataMateria">

      <label>ğŸ•µï¸ Data da anÃ¡lise</label>
      <input type="date" id="dataAnalise">

      <textarea id="link" rows="2" placeholder="Link da matÃ©ria"></textarea>
      <textarea id="obs" rows="2" placeholder="ObservaÃ§Ãµes"></textarea>

      <select id="tipo">
        <option value="positivo">ğŸŸ¢ Positivo</option>
        <option value="neutro">âšª Neutro</option>
        <option value="negativo">ğŸ”´ Negativo</option>
      </select>

      <button id="btnSalvar" onclick="salvarOuAtualizar()">Salvar</button>
      <button id="btnCancelar" class="hidden" onclick="cancelarEdicao()">Cancelar ediÃ§Ã£o</button>

      <div class="rowBtns">
        <button onclick="exportar()">ğŸ“¤ Exportar Excel</button>
        <button onclick="atualizar()">ğŸ”„ Atualizar</button>
      </div>

      <div id="status" class="notice hidden"></div>
      <div id="editBadge" class="badgeEdit hidden">âœï¸ Editando item</div>
    </div>

    <!-- COLUNAS -->
    <div class="columns">
      <div class="column">
        <h3>ğŸŸ¢ Positivo</h3>
        <div id="positivo"></div>
      </div>
      <div class="column">
        <h3>âšª Neutro</h3>
        <div id="neutro"></div>
      </div>
      <div class="column">
        <h3>ğŸ”´ Negativo</h3>
        <div id="negativo"></div>
      </div>
    </div>

  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwmQvUrspy3k497Bo0zSxvOiKasaDY8UxvRs64R2klDJNVDnofdVzXf2oH--v0zfRe1/exec";
const API_TOKEN = "clipping2026seguro";
const SENHA_SITE = "clipping2026";

let dados = [];
let editingId = null;

function formatarData(v){
  if(!v) return "-";
  const d = new Date(v);
  if(isNaN(d)) return v;
  return String(d.getDate()).padStart(2,"0") + "/" +
         String(d.getMonth()+1).padStart(2,"0") + "/" +
         d.getFullYear();
}

function showStatus(msg, warn=false){
  const el = document.getElementById("status");
  el.innerText = msg;
  el.classList.remove("hidden");
  el.classList.toggle("warn", warn);
  setTimeout(()=> el.classList.add("hidden"), 2500);
}

function entrar(){
  if(document.getElementById("senha").value !== SENHA_SITE){
    alert("Senha incorreta");
    return;
  }
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  atualizar();
}

async function apiPost(payload){
  const resp = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  return resp.json();
}

function pegarPayload(){
  return {
    token: API_TOKEN,
    autor: (autor.value || "").trim(),
    tituloAnalise: (tituloAnalise.value || "").trim(),   // NOVO
    titulo: (titulo.value || "").trim(),
    link: (link.value || "").trim(),
    obs: (obs.value || "").trim(),
    tipo: tipo.value,
    dataMateria: dataMateria.value || "",
    dataAnalise: dataAnalise.value || "",
    veiculo: (veiculo.value || "").trim(),
    autoriaMateria: (autoriaMateria.value || "").trim()
  };
}

async function salvarOuAtualizar(){
  const base = pegarPayload();

  if(!base.titulo || !base.link){
    showStatus("Preencha tÃ­tulo da matÃ©ria e link", true);
    return;
  }

  try{
    let out;
    if(!editingId){
      out = await apiPost({ ...base, action:"add" });
    } else {
      out = await apiPost({ ...base, action:"update", id: editingId });
    }

    if(out.ok){
      showStatus(editingId ? "Atualizado âœ…" : "Salvo na nuvem âœ…");
      cancelarEdicao();
      limparCampos();
      await atualizar();
    } else {
      showStatus("Erro: " + (out.error || "desconhecido"), true);
    }
  } catch(e){
    showStatus("Falha de rede.", true);
  }
}

function limparCampos(){
  tituloAnalise.value = "";
  titulo.value = "";
  link.value = "";
  obs.value = "";
  veiculo.value = "";
  autoriaMateria.value = "";
}

function cancelarEdicao(){
  editingId = null;
  document.getElementById("btnSalvar").innerText = "Salvar";
  document.getElementById("btnCancelar").classList.add("hidden");
  document.getElementById("editBadge").classList.add("hidden");
}

function editar(id){
  const item = dados.find(x => String(x.id) === String(id));
  if(!item) return;

  editingId = String(item.id);
  document.getElementById("btnSalvar").innerText = "Atualizar";
  document.getElementById("btnCancelar").classList.remove("hidden");
  document.getElementById("editBadge").classList.remove("hidden");

  autor.value = item.autor || "";
  tituloAnalise.value = item.tituloAnalise || "";
  titulo.value = item.titulo || "";
  link.value = item.link || "";
  obs.value = item.obs || "";
  tipo.value = item.tipo || "neutro";
  dataMateria.value = (item.dataMateria || "").slice(0,10);
  dataAnalise.value = (item.dataAnalise || "").slice(0,10);
  veiculo.value = item.veiculo || "";
  autoriaMateria.value = item.autoriaMateria || "";

  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function atualizar(){
  const resp = await fetch(API_URL);
  const out = await resp.json();
  if(out.ok){
    dados = out.rows || [];
    render();
  }
}

function render(){
  positivo.innerHTML = neutro.innerHTML = negativo.innerHTML = "";

  // Ordena por dataAnalise > dataMateria > dataHora (desc)
  const sorted = [...dados].sort((a,b)=>{
    const keyA = (a.dataAnalise || a.dataMateria || a.dataHora || "");
    const keyB = (b.dataAnalise || b.dataMateria || b.dataHora || "");
    return (""+keyB).localeCompare(""+keyA);
  });

  sorted.forEach(item=>{
    const div = document.createElement("div");
    div.className = "item";

    const meta = [
      item.veiculo ? `ğŸ“° ${item.veiculo}` : "",
      item.autoriaMateria ? `âœï¸ ${item.autoriaMateria}` : ""
    ].filter(Boolean).join(" â€¢ ");

    div.innerHTML = `
      ${item.tituloAnalise ? `<strong>ğŸ“ ${escapeHtml(item.tituloAnalise)}</strong>` : ""}
      <strong>${escapeHtml(item.titulo || "")}</strong>
      <a href="${escapeAttr(item.link || "")}" target="_blank">${escapeHtml(item.link || "")}</a>
      ${meta ? `<small>${escapeHtml(meta)}</small>` : ""}
      ${item.obs ? `<small>ğŸ“ ${escapeHtml(item.obs)}</small>` : ""}
      <small>ğŸ“… MatÃ©ria: ${escapeHtml(formatarData(item.dataMateria))} â€¢ ğŸ•µï¸ AnÃ¡lise: ${escapeHtml(formatarData(item.dataAnalise))}</small>
      <div class="actions">
        <button class="btnEdit" onclick="editar('${escapeAttr(item.id)}')">âœï¸ Editar</button>
        <button class="btnDel" onclick="excluir('${escapeAttr(item.id)}')">ğŸ—‘ï¸ Excluir</button>
      </div>
    `;

    if(item.tipo==="positivo") positivo.appendChild(div);
    else if(item.tipo==="neutro") neutro.appendChild(div);
    else if(item.tipo==="negativo") negativo.appendChild(div);
  });
}

async function excluir(id){
  if(!confirm("Excluir esta matÃ©ria?")) return;
  const out = await apiPost({ token:API_TOKEN, action:"delete", id });
  if(out.ok){
    showStatus("ExcluÃ­do âœ…");
    if(editingId === String(id)) cancelarEdicao();
    atualizar();
  } else {
    showStatus("Erro ao excluir: " + (out.error || "desconhecido"), true);
  }
}

function exportar(){
  let csv = "Tipo;TÃ­tulo da anÃ¡lise;TÃ­tulo da matÃ©ria;VeÃ­culo;Autoria;Link;ObservaÃ§Ãµes;Data MatÃ©ria;Data AnÃ¡lise;Autor;ID\n";
  const sorted = [...dados].sort((a,b)=>{
    const keyA = (a.dataAnalise || a.dataMateria || a.dataHora || "");
    const keyB = (b.dataAnalise || b.dataMateria || b.dataHora || "");
    return (""+keyB).localeCompare(""+keyA);
  });

  sorted.forEach(d=>{
    csv += [
      d.tipo,
      d.tituloAnalise,
      d.titulo,
      d.veiculo,
      d.autoriaMateria,
      d.link,
      d.obs,
      formatarData(d.dataMateria),
      formatarData(d.dataAnalise),
      d.autor,
      d.id
    ].map(v=>`"${String(v||"").replace(/"/g,'""')}"`).join(";") + "\n";
  });

  const blob = new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "clipping.csv";
  a.click();
}

/* Helpers */
function escapeHtml(str) {
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str) {
  return (str ?? "").toString().replaceAll('"', '%22').replaceAll("'", "%27");
}
</script>
</body>
</html>
