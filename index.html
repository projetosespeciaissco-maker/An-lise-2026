<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Clipping JornalÃ­stico (Equipe)</title>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { background:#1f2937; color:#fff; padding:15px; text-align:center; font-size:18px; }
.hidden{display:none;}
#login, #app { padding:20px; }

input, textarea, select {
  width:100%; box-sizing:border-box; padding:12px; margin-top:10px; font-size:14px;
  border:1px solid #ccc; border-radius:6px; resize:vertical;
}
button{
  width:100%; box-sizing:border-box; padding:12px; margin-top:10px; font-size:14px;
  cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#fff;
}
button:hover{ background:#f0f0f0; }

.container{ display:flex; gap:20px; align-items:flex-start; }
.form{ width:32%; background:#fff; padding:15px; border-radius:8px; }
.columns{ width:68%; display:flex; gap:10px; }
.column{ flex:1; background:#fff; padding:10px; border-radius:8px; min-height:300px; }
.column h3{ text-align:center; margin:10px 0; }

.toolbar{ display:flex; gap:8px; margin-top:10px; }
.toolbar button{ width:auto; flex:1; }

.small { font-size:12px; color:#666; margin-top:8px; }
.badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; }

.item { border-bottom:1px solid #ddd; padding:8px 0; }
.item strong{ display:block; margin-bottom:3px; }
.item a{ font-size:12px; color:#2563eb; word-break:break-all; }
.item small{ display:block; color:#555; margin-top:3px; }

.actions{ display:flex; gap:6px; margin-top:6px; }
.actions button{ width:auto; padding:6px 10px; }

.notice{ background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:8px; margin-top:10px; color:#6b4e00; }
.ok{ background:#e7f7ee; border:1px solid #b7ebcd; color:#0f5132; }
</style>
</head>

<body>
<header>ğŸ“Š Clipping JornalÃ­stico (Equipe)</header>

<div id="login">
  <h3>ğŸ”’ Acesso</h3>
  <input type="password" id="senha" placeholder="Digite a senha do site">
  <button onclick="login()">Entrar</button>
  <div class="small">Senha simples (para evitar acesso casual). Dados ficam na planilha.</div>
</div>

<div id="app" class="hidden">
  <div class="container">

    <div class="form">
      <h3>â• Nova MatÃ©ria</h3>

      <input id="autor" placeholder="Seu nome (ex: Raquel)">

      <input id="titulo" placeholder="TÃ­tulo da matÃ©ria">
      <textarea id="link" rows="3" placeholder="Cole o link aqui"></textarea>
      <textarea id="obs" rows="2" placeholder="ğŸ“ ObservaÃ§Ãµes (opcional)"></textarea>

      <select id="tipo">
        <option value="positivo">ğŸŸ¢ Positivo</option>
        <option value="neutro">âšª Neutro</option>
        <option value="negativo">ğŸ”´ Negativo</option>
      </select>

      <div class="toolbar">
        <button onclick="salvarOuAtualizar()" id="btnSalvar">Salvar</button>
        <button onclick="limparFormulario()" id="btnLimpar">Limpar</button>
      </div>

      <div class="toolbar">
        <button onclick="exportar()">ğŸ“¤ Exportar Excel</button>
        <button onclick="atualizar()">ğŸ”„ Atualizar</button>
      </div>

      <div id="status" class="notice hidden"></div>

      <div class="small">
        <span class="badge">Atualiza a cada 15s</span>
        <br>Equipe alimenta junto via planilha.
      </div>
    </div>

    <div class="columns">
      <div class="column">
        <h3>ğŸŸ¢ Positivo (<span id="cPos">0</span>)</h3>
        <div id="positivo"></div>
      </div>

      <div class="column">
        <h3>âšª Neutro (<span id="cNeu">0</span>)</h3>
        <div id="neutro"></div>
      </div>

      <div class="column">
        <h3>ğŸ”´ Negativo (<span id="cNeg">0</span>)</h3>
        <div id="negativo"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ======= CONFIGURE AQUI ======= */
const API_URL = "https://script.google.com/macros/s/AKfycbwmQvUrspy3k497Bo0zSxvOiKasaDY8UxvRs64R2klDJNVDnofdVzXf2oH--v0zfRe1/exec";
const API_TOKEN = "clipping2026seguro";
const SENHA_SITE = "clipping2026"; // pode mudar se quiser
/* ============================== */

let dados = [];
let editingId = null;

function showStatus(msg, ok=false) {
  const el = document.getElementById("status");
  el.classList.remove("hidden");
  el.classList.toggle("ok", !!ok);
  el.innerText = msg;
  setTimeout(()=> el.classList.add("hidden"), 3000);
}

function login() {
  if (document.getElementById("senha").value !== SENHA_SITE) {
    alert("Senha incorreta");
    return;
  }
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  atualizar();
  setInterval(atualizar, 15000);
}

async function apiPost(payload) {
  const resp = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  return resp.json();
}

async function atualizar() {
  try {
    const resp = await fetch(API_URL);
    const out = await resp.json();
    if (!out.ok) {
      showStatus("Erro ao carregar: " + (out.error || "desconhecido"));
      return;
    }

    dados = (out.rows || []).map(r => ({
      id: String(r.id || ""),
      dataHora: r.dataHora,
      tipo: (r.tipo || "").toString(),
      titulo: (r.titulo || "").toString(),
      link: (r.link || "").toString(),
      obs: (r.obs || "").toString(),
      autor: (r.autor || "").toString()
    }));

    dados.sort((a,b)=> (""+b.dataHora).localeCompare(""+a.dataHora));
    render();
  } catch (e) {
    showStatus("Falha de rede ao carregar.");
  }
}

function limparFormulario() {
  editingId = null;
  document.getElementById("btnSalvar").innerText = "Salvar";
  titulo.value = "";
  link.value = "";
  obs.value = "";
}

function preencherParaEditar(item) {
  editingId = item.id;
  document.getElementById("btnSalvar").innerText = "Atualizar";
  titulo.value = item.titulo;
  link.value = item.link;
  obs.value = item.obs;
  tipo.value = item.tipo;
}

async function salvarOuAtualizar() {
  const autorVal = autor.value.trim() || "Equipe";
  const tituloVal = titulo.value.trim();
  const linkVal = link.value.trim();
  const obsVal = obs.value.trim();
  const tipoVal = tipo.value;

  if (!tituloVal || !linkVal) {
    alert("Preencha tÃ­tulo e link");
    return;
  }

  try {
    if (!editingId) {
      const out = await apiPost({
        token: API_TOKEN,
        action: "add",
        autor: autorVal,
        tipo: tipoVal,
        titulo: tituloVal,
        link: linkVal,
        obs: obsVal
      });

      if (!out.ok) {
        showStatus("Erro ao salvar: " + (out.error || "desconhecido"));
        return;
      }
      showStatus("Salvo na nuvem âœ…", true);
      limparFormulario();
      await atualizar();
    } else {
      const out = await apiPost({
        token: API_TOKEN,
        action: "update",
        id: editingId,
        autor: autorVal,
        tipo: tipoVal,
        titulo: tituloVal,
        link: linkVal,
        obs: obsVal
      });

      if (!out.ok) {
        showStatus("Erro ao atualizar: " + (out.error || "desconhecido"));
        return;
      }
      showStatus("Atualizado âœ…", true);
      limparFormulario();
      await atualizar();
    }
  } catch (e) {
    showStatus("Falha de rede ao salvar/atualizar.");
  }
}

async function excluirItem(id) {
  if (!confirm("Excluir esta matÃ©ria?")) return;
  try {
    const out = await apiPost({ token: API_TOKEN, action: "delete", id });
    if (!out.ok) {
      showStatus("Erro ao excluir: " + (out.error || "desconhecido"));
      return;
    }
    showStatus("ExcluÃ­do âœ…", true);
    await atualizar();
  } catch (e) {
    showStatus("Falha de rede ao excluir.");
  }
}

function render() {
  positivo.innerHTML = "";
  neutro.innerHTML = "";
  negativo.innerHTML = "";

  const pos = dados.filter(d => d.tipo === "positivo");
  const neu = dados.filter(d => d.tipo === "neutro");
  const neg = dados.filter(d => d.tipo === "negativo");

  cPos.innerText = pos.length;
  cNeu.innerText = neu.length;
  cNeg.innerText = neg.length;

  for (const item of dados) {
    const div = document.createElement("div");
    div.className = "item";

    const dataTxt = item.dataHora ? new Date(item.dataHora).toLocaleString() : "";
    const autorTxt = item.autor ? `ğŸ‘¤ ${item.autor}` : "";

    div.innerHTML = `
      <strong>${escapeHtml(item.titulo)}</strong>
      <a href="${escapeAttr(item.link)}" target="_blank">${escapeHtml(item.link)}</a>
      ${item.obs ? `<small>ğŸ“ ${escapeHtml(item.obs)}</small>` : ""}
      <small>ğŸ“… ${escapeHtml(dataTxt)} ${autorTxt ? " â€¢ " + escapeHtml(autorTxt) : ""}</small>
      <div class="actions">
        <button onclick="onEditar('${escapeAttr(item.id)}')">âœï¸ Editar</button>
        <button onclick="excluirItem('${escapeAttr(item.id)}')">ğŸ—‘ï¸ Excluir</button>
      </div>
    `;

    if (item.tipo === "positivo") positivo.appendChild(div);
    else if (item.tipo === "neutro") neutro.appendChild(div);
    else negativo.appendChild(div);
  }
}

function onEditar(id) {
  const item = dados.find(d => d.id === id);
  if (!item) return;
  preencherParaEditar(item);
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ===== Export Excel (pt-BR) ===== */
function csvEscape(value) {
  const v = (value ?? "").toString().replace(/\r?\n/g, " ");
  return `"${v.replace(/"/g, '""')}"`;
}

function exportar() {
  const sep = ";";
  let csv = ["Tipo","TÃ­tulo","Link","ObservaÃ§Ãµes","Data/Hora","Autor"].join(sep);

  dados.forEach(d => {
    csv += "\n" + [
      csvEscape(d.tipo),
      csvEscape(d.titulo),
      csvEscape(d.link),
      csvEscape(d.obs || ""),
      csvEscape(d.dataHora ? new Date(d.dataHora).toLocaleString() : ""),
      csvEscape(d.autor || "")
    ].join(sep);
  });

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "clipping.csv";
  a.click();
}

/* ===== Helpers ===== */
function escapeHtml(str) {
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str) {
  return (str ?? "").toString().replaceAll('"', '%22').replaceAll("'", "%27");
}
</script>

</body>
</html>
