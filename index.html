<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Clipping JornalÃ­stico</title>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { background:#1f2937; color:#fff; padding:15px; text-align:center; font-size:18px; }
.hidden{display:none;}
#login, #app { padding:20px; }

input, textarea, select {
  width:100%; box-sizing:border-box; padding:10px; margin-top:8px;
  border:1px solid #ccc; border-radius:6px; font-size:14px;
}
label{ font-size:12px; color:#444; margin-top:10px; display:block; }

button{
  width:100%; padding:10px; margin-top:10px;
  border-radius:6px; border:1px solid #ccc; cursor:pointer;
  background:#fff;
}
button:hover{ background:#eee; }

.rowBtns{ display:flex; gap:8px; }
.rowBtns button{ width:50%; }

.container{ display:flex; gap:20px; align-items:flex-start; }
.form{ width:32%; background:#fff; padding:15px; border-radius:8px; }
.columns{ width:68%; display:flex; gap:10px; }
.column{ flex:1; background:#fff; padding:10px; border-radius:8px; min-height:300px; }
.column h3{ text-align:center; margin:10px 0; }

.item{
  border-bottom:1px solid #ddd;
  padding:8px 0;
}
.item strong{ display:block; margin-bottom:4px; }
.item a{ font-size:12px; color:#2563eb; word-break:break-all; }
.item small{ display:block; color:#555; margin-top:3px; }

.actions{ display:flex; gap:6px; margin-top:8px; }
.actions button{
  width:auto; padding:5px 8px; font-size:12px; margin-top:0;
  border-radius:6px;
}
.btnDel{ border-color:#fca5a5; }
.btnDel:hover{ background:#fee2e2; }

.notice{
  background:#e7f7ee;
  border:1px solid #b7ebcd;
  color:#0f5132;
  padding:8px;
  border-radius:6px;
  margin-top:10px;
  font-size:13px;
}
.notice.warn{
  background:#fff3cd;
  border:1px solid #ffeeba;
  color:#6b4e00;
}
</style>
</head>

<body>
<header>ğŸ“Š Clipping JornalÃ­stico</header>

<div id="login">
  <h3>ğŸ”’ Acesso</h3>
  <input type="password" id="senha" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<div id="app" class="hidden">
  <div class="container">

    <!-- FORMULÃRIO -->
    <div class="form">
      <h3>â• Nova MatÃ©ria</h3>

      <input id="autor" placeholder="Seu nome">

      <input id="titulo" placeholder="TÃ­tulo da matÃ©ria">

      <label>ğŸ“… Data da matÃ©ria</label>
      <input type="date" id="dataMateria">

      <label>ğŸ•µï¸ Data da anÃ¡lise</label>
      <input type="date" id="dataAnalise">

      <textarea id="link" rows="2" placeholder="Link da matÃ©ria"></textarea>
      <textarea id="obs" rows="2" placeholder="ObservaÃ§Ãµes"></textarea>

      <select id="tipo">
        <option value="positivo">ğŸŸ¢ Positivo</option>
        <option value="neutro">âšª Neutro</option>
        <option value="negativo">ğŸ”´ Negativo</option>
      </select>

      <button onclick="salvar()">Salvar</button>

      <div class="rowBtns">
        <button onclick="exportar()">ğŸ“¤ Exportar Excel</button>
        <button onclick="atualizar()">ğŸ”„ Atualizar</button>
      </div>

      <div id="status" class="notice hidden"></div>
    </div>

    <!-- COLUNAS -->
    <div class="columns">
      <div class="column">
        <h3>ğŸŸ¢ Positivo</h3>
        <div id="positivo"></div>
      </div>
      <div class="column">
        <h3>âšª Neutro</h3>
        <div id="neutro"></div>
      </div>
      <div class="column">
        <h3>ğŸ”´ Negativo</h3>
        <div id="negativo"></div>
      </div>
    </div>

  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwmQvUrspy3k497Bo0zSxvOiKasaDY8UxvRs64R2klDJNVDnofdVzXf2oH--v0zfRe1/exec";
const API_TOKEN = "clipping2026seguro";
const SENHA_SITE = "clipping2026";

let dados = [];

function showStatus(msg, type="ok"){
  const el = document.getElementById("status");
  el.classList.remove("hidden");
  el.classList.toggle("warn", type !== "ok");
  el.innerText = msg;
  setTimeout(()=> el.classList.add("hidden"), 2500);
}

function login(){
  if(document.getElementById("senha").value !== SENHA_SITE){
    alert("Senha incorreta");
    return;
  }
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  atualizar();
  setInterval(atualizar, 15000);
}

async function apiPost(payload){
  const resp = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  return resp.json();
}

async function salvar(){
  const payload = {
    token: API_TOKEN,
    action: "add",
    autor: (autor.value || "").trim(),
    titulo: (titulo.value || "").trim(),
    link: (link.value || "").trim(),
    obs: (obs.value || "").trim(),
    tipo: tipo.value,
    dataMateria: dataMateria.value || "",
    dataAnalise: dataAnalise.value || ""
  };

  if(!payload.titulo || !payload.link){
    showStatus("Preencha tÃ­tulo e link.", "warn");
    return;
  }

  try{
    const out = await apiPost(payload);
    if(out.ok){
      showStatus("Salvo na nuvem âœ…", "ok");
      limpar();
      await atualizar();
    } else {
      showStatus("Erro ao salvar: " + (out.error || "desconhecido"), "warn");
    }
  } catch(e){
    showStatus("Falha de rede ao salvar.", "warn");
  }
}

function limpar(){
  titulo.value = "";
  link.value = "";
  obs.value = "";
}

async function atualizar(){
  try{
    const resp = await fetch(API_URL);
    const out = await resp.json();
    if(out.ok){
      dados = Array.isArray(out.rows) ? out.rows : [];
      render();
    } else {
      showStatus("Erro ao carregar: " + (out.error || "desconhecido"), "warn");
    }
  } catch(e){
    showStatus("Falha de rede ao carregar.", "warn");
  }
}

function render(){
  positivo.innerHTML = "";
  neutro.innerHTML = "";
  negativo.innerHTML = "";

  // Ordena por dataAnalise > dataMateria > dataHora (desc)
  const sorted = [...dados].sort((a,b)=>{
    const keyA = (a.dataAnalise || a.dataMateria || a.dataHora || "");
    const keyB = (b.dataAnalise || b.dataMateria || b.dataHora || "");
    return (""+keyB).localeCompare(""+keyA);
  });

  for(const item of sorted){
    const div = document.createElement("div");
    div.className = "item";

    const dm = item.dataMateria ? `ğŸ“… MatÃ©ria: ${item.dataMateria}` : "ğŸ“… MatÃ©ria: -";
    const da = item.dataAnalise ? `ğŸ•µï¸ AnÃ¡lise: ${item.dataAnalise}` : "ğŸ•µï¸ AnÃ¡lise: -";
    const obsHtml = item.obs ? `<small>ğŸ“ ${escapeHtml(item.obs)}</small>` : "";

    div.innerHTML = `
      <strong>${escapeHtml(item.titulo || "")}</strong>
      <a href="${escapeAttr(item.link || "")}" target="_blank">${escapeHtml(item.link || "")}</a>
      ${obsHtml}
      <small>${escapeHtml(dm)} â€¢ ${escapeHtml(da)}</small>
      <div class="actions">
        <button class="btnDel" onclick="excluirItem('${escapeAttr(item.id)}')">ğŸ—‘ï¸ Excluir</button>
      </div>
    `;

    if(item.tipo === "positivo") positivo.appendChild(div);
    else if(item.tipo === "neutro") neutro.appendChild(div);
    else if(item.tipo === "negativo") negativo.appendChild(div);
  }
}

async function excluirItem(id){
  if(!id){
    showStatus("ID vazio (nÃ£o dÃ¡ pra excluir).", "warn");
    return;
  }
  if(!confirm("Excluir esta matÃ©ria da nuvem?")) return;

  try{
    const out = await apiPost({ token: API_TOKEN, action: "delete", id });
    if(out.ok){
      showStatus("ExcluÃ­do âœ…", "ok");
      await atualizar();
    } else {
      showStatus("Erro ao excluir: " + (out.error || "desconhecido"), "warn");
    }
  } catch(e){
    showStatus("Falha de rede ao excluir.", "warn");
  }
}

/* ===== EXPORTAÃ‡ÃƒO EXCEL (CSV pt-BR) ===== */
function csvEscape(value) {
  const v = (value ?? "").toString().replace(/\r?\n/g, " ");
  return `"${v.replace(/"/g, '""')}"`;
}

function exportar(){
  const sep = ";";
  let csv = ["Tipo","TÃ­tulo","Link","ObservaÃ§Ãµes","Data da MatÃ©ria","Data da AnÃ¡lise","Autor","ID"].join(sep);

  const sorted = [...dados].sort((a,b)=>{
    const keyA = (a.dataAnalise || a.dataMateria || a.dataHora || "");
    const keyB = (b.dataAnalise || b.dataMateria || b.dataHora || "");
    return (""+keyB).localeCompare(""+keyA);
  });

  for(const d of sorted){
    csv += "\n" + [
      csvEscape(d.tipo || ""),
      csvEscape(d.titulo || ""),
      csvEscape(d.link || ""),
      csvEscape(d.obs || ""),
      csvEscape(d.dataMateria || ""),
      csvEscape(d.dataAnalise || ""),
      csvEscape(d.autor || ""),
      csvEscape(d.id || "")
    ].join(sep);
  }

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "clipping.csv";
  a.click();
}

/* ===== Helpers ===== */
function escapeHtml(str) {
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str) {
  return (str ?? "").toString().replaceAll('"', '%22').replaceAll("'", "%27");
}
</script>

</body>
</html>
